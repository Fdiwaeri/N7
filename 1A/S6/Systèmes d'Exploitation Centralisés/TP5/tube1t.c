#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <signal.h>
#include <string.h>

// Gestionnaire de signal pour le fils
void handler(int sig) {
    printf("Fils: Signal %d reçu et ignoré\n", sig);
}

int main(void) {
    int tube[2];
    pid_t pid;
    const int N = 1024; // Taille du tableau en octets
    char buffer[N];
    int status;

    // Initialisation du tableau avec des données
    memset(buffer, 'A', N);

    // Le père crée un tube
    if (pipe(tube) == -1) {
        perror("Erreur lors de la création du tube");
        exit(EXIT_FAILURE);
    }

    // Puis il crée un fils
    pid = fork();
    if (pid == -1) {
        perror("Erreur lors du fork");
        exit(EXIT_FAILURE);
    }

    if (pid > 0) {
        // Processus père
        close(tube[0]); // Fermeture du descripteur de lecture non utilisé
        
        printf("Père: Je vais écrire en boucle dans le tube\n");
        printf("Père: Utilisez Ctrl+C pour interrompre le programme\n");
        
        // Écriture en boucle infinie
        int tour = 0;
        while (1) {
            ssize_t nb_ecrits = write(tube[1], buffer, N);
            printf("Père: Tour %d - Écriture de %zd octets\n", ++tour, nb_ecrits);
            sleep(1);
            
            // Si l'écriture a échoué, sortir de la boucle
            if (nb_ecrits <= 0) {
                perror("Erreur d'écriture dans le tube");
                break;
            }
        }
        
        // Fermeture du descripteur d'écriture
        close(tube[1]);
        
        // Attente de la fin du fils
        wait(&status);
        printf("Père: Mon fils s'est terminé avec le code %d\n", 
               WEXITSTATUS(status));
    } else {
        // Processus fils
        close(tube[1]); // Fermeture du descripteur d'écriture non utilisé
        
        // Configuration du gestionnaire de signal
        struct sigaction sa;
        sa.sa_handler = handler;
        sigemptyset(&sa.sa_mask);
        sa.sa_flags = 0;
        
        if (sigaction(SIGUSR1, &sa, NULL) == -1) {
            perror("Erreur lors de la configuration du gestionnaire de signal");
            exit(EXIT_FAILURE);
        }
        
        printf("Fils: J'attends un signal (utilisez 'kill -USR1 %d' dans un autre terminal)\n", getpid());
        pause(); // Attente d'un signal
        
        printf("Fils: Je vais lire 10*%d = %d octets depuis le tube\n", N, 10*N);
        
        char read_buffer[10*N];
        ssize_t nb_lus = read(tube[0], read_buffer, 10*N);
        
        printf("Fils: J'ai lu %zd octets depuis le tube\n", nb_lus);
        
        // Fermeture du descripteur de lecture
        close(tube[0]);
        
        printf("Fils: Terminé\n");
        exit(EXIT_SUCCESS);
    }

    return EXIT_SUCCESS;
}
