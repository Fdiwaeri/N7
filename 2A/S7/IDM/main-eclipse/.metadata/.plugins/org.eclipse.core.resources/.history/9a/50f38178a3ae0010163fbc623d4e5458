-- @path SimplePDL=/fr.n7.simplePDL/SimplePDL.ecore
-- @path PetriNet=/fr.n7.petriNet/PetriNet.ecore

module simplepdl2petrinet;
create OUT : PetriNet from IN : SimplePDL;

-- Helper conservé (getProcess)
helper context SimplePDL!ProcessElement
def: getProcess() : SimplePDL!Process =
SimplePDL!Process.allInstances()->select(e | e.processElements->includes(self));

-- Traduire un Process en un PetriNet de même nom
rule Process2PetriNet {
	from p: SimplePDL!Process
	to petrinet: PetriNet!PetriNet (
		name <- p.name,
		-- CORRECTION: Assurer que tous les éléments générés sont contenus par le PetriNet.
        petrinetelement <- 
            p.processElements
                ->union(SimplePDL!UtilisationRessources.allInstances())
                ->collect(e | thisModule.resolveTemp(e))
                ->flatten()
		)
}

--Pour chaque élément WorkDefinition, on veut créer un élément motif de même nom.
rule WD2PetriNet {
	from wd : SimplePDL!WorkDefinition
	to
	--Places
 	 p_ready: PetriNet!Place(
 		  name <- wd.name + '_ready',
 		  jetons <- 1),
 		 
 			
  	 p_running: PetriNet!Place(
  		 name <- wd.name + '_running',
  		 jetons <- 0),
 	
  	 p_finished: PetriNet!Place(
  		 name <- wd.name + '_finished',
  		 jetons <- 0),
 		
  	 p_started: PetriNet!Place(
  		 name <- wd.name + '_started',
  		 jetons <- 0),
 		
	--Transitions
  
 	t_start: PetriNet!Transition(name <- wd.name + '_start'), 		
    t_finish: PetriNet!Transition(name <- wd.name + '_finish'),
	
 	--Arcs (CORRECTION: Utilisation des classes ArcPlaceTransition et ArcTransitionPlace)
	
 	 e_r_s: PetriNet!ArcPlaceTransition( -- Place -> Transition (ready -> start)
 	 	type <- #normal,
  		 entree <- p_ready,
  		 sortie <- t_start,
  		 poids <- 1
  		 ),
 	
 	 e_s_sd: PetriNet!ArcTransitionPlace( -- Transition -> Place (start -> started)
 	 	 type <- #normal,
  		 entree <- t_start,
  		 sortie <- p_started,
  		 poids <- 1
  		),
 	
  	 e_s_rg: PetriNet!ArcTransitionPlace( -- Transition -> Place (start -> running)
  	 	type <- #normal,
  		 entree <- t_start,
  		 sortie <- p_running,
  		 poids <- 1
  		 ),
 	
  	 e_rg_f: PetriNet!ArcPlaceTransition( -- Place -> Transition (running -> finish)
  	 	type <- #normal,
  		 entree <- p_running,
  		 sortie <- t_finish,
  		 poids <- 1
 ),
 	
  	 e_f_fd: PetriNet!ArcTransitionPlace( -- Transition -> Place (finish -> finished)
  	 	 type <- #normal,
  		 entree <- t_finish,
  		 sortie <- p_finished,
  		 poids <- 1
  		)
}


rule WorkSequence2PetriNet {
	from ws: SimplePDL!WorkSequence
	to
		-- CORRECTION: Les WorkSequences créent des Read Arcs, qui sont Place -> Transition
		Arc_ws : PetriNet!ArcPlaceTransition( 
			type <- #readArc
			,poids <- 1
			,entree <- thisModule.resolveTemp(ws.predecessor,'p'+
				(if ((ws.linkType = #finishToFinish) or (ws.linkType = #finishToStart))
					then '_finished'
					else  '_started'
					endif))
			,sortie <- thisModule.resolveTemp(ws.successor,'t' + 
				(if ((ws.linkType = #finishToStart) or (ws.linkType = #startToStart))
					then  '_start'
					else '_finish'
					endif))
					)
}

