-- @path SimplePDL=file:/home/fek2775/Annee_2/IDM2023/fr.n7.simplePDL2/SimplePDL.ecore
-- @path PN=file:/home/fek2775/Annee_2/IDM2023/fr.n7.petriNet/PetriNet.ecore

module SimplePDLToPetriNet;
create OUT : PN from IN : SimplePDL;

rule Process2PetriNet {
    from
        process : SimplePDL!Process
    to
        petriNet : PN!PetriNet (
            name <- process.name + ' - PetriNet'
        )
}

rule WD2Nodes {
    from
        wd : SimplePDL!WorkDefinition
    to
        -- La transition qui représente l'activité elle-même
        transition : PN!Transition (
            name <- wd.name
        ),
        -- La place de pré-condition (avant l'activité)
        startPlace : PN!Place (
            name <- wd.name + '_Pre'
        ),
        -- La place de post-condition (après l'activité)
        endPlace : PN!Place (
            name <- wd.name + '_Post'
        ),
        
        -- Arcs par défaut (séquence de base : start -> transition -> end)
        
        -- Arc 1: Place_Pre -> Transition
        startArc : PN!ArcPlaceTransition (
            source <- startPlace,
            target <- transition,
            weight <- 1 -- Poids par défaut [cite: 21]
        ),
        -- Arc 2: Transition -> Place_Post
        endArc : PN!ArcTransitionPlace (
            source <- transition,
            target <- endPlace,
            weight <- 1 -- Poids par défaut [cite: 21]
        )
}

helper context SimplePDL!WorkDefinition
def: getStartPlace() : PN!Place =
    thisModule.resolveTemp(self, 'startPlace');

helper context SimplePDL!WorkDefinition
def: getEndPlace() : PN!Place =
    thisModule.resolveTemp(self, 'endPlace');

helper context SimplePDL!WorkDefinition
def: getTransition() : PN!Transition =
    thisModule.resolveTemp(self, 'transition');

rule WS2Arc {
    from
        ws : SimplePDL!WorkSequence
    to
        -- L'arc de causalité est créé uniquement si c'est un lien FS.
        arc : PN!ArcTransitionPlace
        -- Le code Java ne traite que FINISH_TO_START pour l'arc simple
        (
            source <- ws.predecessor.getTransition(),
            target <- ws.successor.getStartPlace(),
            weight <- 1
        )
    -- On applique cette règle seulement si le type est FINISH_TO_START
    where
        (ws.linkType = #finishToStart)
}

rule Resource2Place {
    from
        res : SimplePDL!Resource
    to
        place : PN!Place (
            name <- res.name,
            -- Le marquage initial est la quantité de ressource disponible
            initialMarketing <- res.quantity 
        )
}

rule UsageResource2Arcs {
    from
        ur : SimplePDL!UsageResource
    to
        -- Arc 1: Consommation (Place -> Transition)
        consumeArc : PN!ArcPlaceTransition (
            source <- ur.resource, -- La place de la ressource
            target <- ur.workdefinition.getTransition(), -- La transition de l'activité
            weight <- ur.UsageQuantity -- Le poids est la quantité utilisée
        ),
        
        -- Arc 2: Libération (Transition -> Place)
        releaseArc : PN!ArcTransitionPlace (
            source <- ur.workdefinition.getTransition(),
            target <- ur.resource,
            weight <- ur.UsageQuantity -- Le poids est la quantité libérée
        )
}

